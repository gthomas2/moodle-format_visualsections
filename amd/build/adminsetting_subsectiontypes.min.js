define ("format_visualsections/adminsetting_subsectiontypes",["jquery","core/templates","core/modal_factory","core/modal_events","core/fragment","core/ajax"],function(a,b,c,d,e,f){return{init:function init(){var g=function(){var b=[];a(".subsectiontypes ul li").each(function(){var c=a(this).find("[name*=\"code\"]").val(),d=a(this).find("[name*=\"name\"]").val(),e=a(this).find("button.imagethumb").data("imgsrc");if("undefined"==typeof e){e=null}c=c.replace("|"," ");d=d.replace("|"," ");b.push(c+"|"+d+"|"+e)});var c=a(".subsectiontypes .js-data-field");a(c).val(b.join("\n"))};a(".subsectiontypes").on("click",".js-addsubsection",function(c){c.preventDefault();var d=0,e=0;a(".subsectiontypes .subsectiontyperow").each(function(){e++;var b=a(this).data("pos");if(b&&b>d){d=b}});if(4<e){alert("Max sub sections 5");return}var f={pos:d+1,code:null,name:null,image:null};b.render("format_visualsections/subsectiontyperow",f).then(function(b){a(".subsectiontypes ul").append(b)})});a(".subsectiontypes").on("keyup change","input",function(a){a.preventDefault();g()});a(".subsectiontypes").on("click",".js-removesubsection",function(b){b.preventDefault();a(this).parent("li").remove();g()});var h=null,i=function(){a("#image-upload").html("<div class=\"spinner\"></div>");h.show();return e.loadFragment("format_visualsections","filepicker",M.cfg.contextid,[]).done(function(c,d){if(!a("#image-upload").length){return}b.replaceNodeContents(a("#image-upload"),c,d)})},j=!1,k=function(e,k){if(h){h.rowEl=e;h.rowData=k;i();return}if(j){return}j=!0;c.create({type:c.types.SAVE_CANCEL,title:"Add image",body:"<div id=\"image-upload\"></div>"}).then(function(c){h=c;h.setSmall();h.rowEl=e;h.rowData=k;i();h.getRoot().on(d.save,function(){var d=a(".filepicker-filename a").attr("href"),e=/(?:draftfile.php\/)(.*)$/,h=d.match(e),i=h[1].split("/"),j=i[3],k=i[4];return f.call([{methodname:"format_visualsections_subtopic_addimage",args:{request:{draftitemid:j,filename:k}}}])[0].then(function(d){if(!d.success){alert("Error: failed to upload image")}var e=d.imagefile;c.rowData.image=e;b.render("format_visualsections/subsectiontyperow",c.rowData).then(function(b){a(c.rowEl).replaceWith(b);g()})})});c.getRoot().on(d.hidden,function(){a("#image-upload").html("")})})};a(".subsectiontypes").on("click",".js-setimage",function(b){b.preventDefault();var c=a(this).parent(".subsectiontyperow"),d=a(c).find("[name*=\"code\"]").val(),e=a(c).find("[name*=\"name\"]").val(),f=a(this).data("imgsrc");k(c,{code:d,name:e,image:f})});a(".subsectiontypes").addClass("jsloaded")}}});
//# sourceMappingURL=adminsetting_subsectiontypes.min.js.map
