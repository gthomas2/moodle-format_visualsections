{"version":3,"sources":["../src/adminsetting_subsectiontypes.js"],"names":["define","$","Templates","ModalFactory","ModalEvents","Fragment","Ajax","init","rewriteDataField","data","each","code","find","val","name","image","replace","push","dataField","join","on","e","preventDefault","greatestPos","count","pos","alert","render","then","html","append","parent","remove","imageModal","showImageModal","show","loadFragment","M","cfg","contextid","done","js","length","replaceNodeContents","addingModal","addImageModal","rowEl","rowData","create","type","types","SAVE_CANCEL","title","body","modal","setSmall","getRoot","save","draft","attr","regex","found","match","filecomps","split","draftItemId","fileName","call","methodname","args","result","success","imgSrc","imagefile","replaceWith","hidden","row","addClass"],"mappings":"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","sourcesContent":["define([\"jquery\",\n    \"core/templates\",\n    \"core/modal_factory\",\n    \"core/modal_events\",\n    \"core/fragment\",\n    \"core/ajax\"\n], function($, Templates, ModalFactory, ModalEvents, Fragment, Ajax) {\n    return {\n        init: function() {\n            var rewriteDataField = function() {\n                var data = [];\n                $('.subsectiontypes ul li').each(function() {\n                    var code = $(this).find('[name*=\"code\"]').val();\n                    var name = $(this).find('[name*=\"name\"]').val();\n                    var image = $(this).find('button.imagethumb').data('imgsrc');\n                    if (typeof(image) === 'undefined') {\n                        image = null;\n                    }\n                    code = code.replace('|', ' '); // No pipes allowed.\n                    name = name.replace('|', ' '); // No pipes allowed.\n                    data.push(code+'|'+name+'|'+image);\n                });\n                var dataField = $('.subsectiontypes .js-data-field');\n                $(dataField).val(data.join(\"\\n\"));\n            };\n\n            // Listen for add sub section.\n            $('.subsectiontypes').on('click', '.js-addsubsection', function(e) {\n                e.preventDefault();\n                var greatestPos = 0;\n\n                var count = 0;\n                $('.subsectiontypes .subsectiontyperow').each(function() {\n                    count ++;\n                    var pos = $(this).data('pos');\n                    if (pos && pos > greatestPos) {\n                        greatestPos = pos;\n                    }\n                });\n\n                if (count > 4) {\n                    // TODO localise.\n                    alert ('Max sub sections 5');\n                    return;\n                }\n\n                var data = {\n                    pos: greatestPos + 1,\n                    code: null,\n                    name: null,\n                    image: null\n                };\n                Templates.render('format_visualsections/subsectiontyperow', data)\n                    .then(function(html) {\n                        $('.subsectiontypes ul').append(html);\n                    });\n            });\n\n            // Listen for field value changes.\n            $('.subsectiontypes').on('keyup change', 'input', function(e) {\n                e.preventDefault();\n                rewriteDataField();\n            });\n\n            // Listen remove sub section.\n            $('.subsectiontypes').on('click', '.js-removesubsection', function(e) {\n                e.preventDefault();\n                $(this).parent('li').remove();\n                rewriteDataField();\n            });\n\n            var imageModal = null;\n\n            var showImageModal = function() {\n                $('#image-upload').html('<div class=\"spinner\"></div>');\n                imageModal.show();\n                return Fragment.loadFragment(\"format_visualsections\", \"filepicker\", M.cfg.contextid, [])\n                    .done(function(html, js) {\n                        if (!$(\"#image-upload\").length) {\n                            return;\n                        }\n                        Templates.replaceNodeContents(\n                            $(\"#image-upload\"),\n                            html,\n                            js\n                        );\n                    });\n            };\n\n            var addingModal = false;\n\n            var addImageModal = function(rowEl, rowData) {\n                if (imageModal) {\n                    imageModal.rowEl = rowEl;\n                    imageModal.rowData = rowData;\n                    showImageModal();\n                    return;\n                }\n                if (addingModal) {\n                    return;\n                }\n                addingModal = true;\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    title: \"Add image\",\n                    body: `<div id=\"image-upload\"></div>`\n                })\n                .then(function(modal) {\n                    imageModal = modal;\n                    imageModal.setSmall();\n                    imageModal.rowEl = rowEl;\n                    imageModal.rowData = rowData;\n                    showImageModal();\n\n                    // Handle save event.\n                    imageModal.getRoot().on(ModalEvents.save, function() {\n                        const draft = $(\".filepicker-filename a\").attr(\"href\");\n                        const regex = /(?:draftfile.php\\/)(.*)$/;\n                        const found = draft.match(regex);\n                        const filecomps = found[1].split('/');\n                        const draftItemId = filecomps[3];\n                        const fileName = filecomps[4];\n\n                        return Ajax.call([\n                            {\n                                methodname: \"format_visualsections_subtopic_addimage\",\n                                args:{\n                                    \"request\": {\"draftitemid\": draftItemId, \"filename\": fileName}\n                                }\n                            }\n                        ])[0]\n                            .then(function(result) {\n                                if (!result.success) {\n                                    // TODO - localise.\n                                    alert ('Error: failed to upload image');\n                                }\n                                var imgSrc = result.imagefile;\n                                modal.rowData.image = imgSrc;\n                                Templates.render('format_visualsections/subsectiontyperow', modal.rowData)\n                                    .then(function(html) {\n                                        $(modal.rowEl).replaceWith(html);\n                                        rewriteDataField();\n                                    });\n                            });\n                    });\n\n                    modal.getRoot().on(ModalEvents.hidden, function() {\n                        $(\"#image-upload\").html(\"\");\n                    });\n                });\n            };\n\n            // Listen add image.\n            $('.subsectiontypes').on('click', '.js-setimage', function(e) {\n                e.preventDefault();\n                const row = $(this).parent('.subsectiontyperow');\n                const code = $(row).find('[name*=\"code\"]').val();\n                const name = $(row).find('[name*=\"name\"]').val();\n                const image = $(this).data('imgsrc');\n                const rowData = {\n                    code: code,\n                    name: name,\n                    image: image\n                };\n\n                addImageModal(row, rowData);\n            });\n\n            $('.subsectiontypes').addClass('jsloaded');\n        }\n    };\n});"],"file":"adminsetting_subsectiontypes.min.js"}