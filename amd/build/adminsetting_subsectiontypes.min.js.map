{"version":3,"sources":["../src/adminsetting_subsectiontypes.js"],"names":["define","$","Templates","ModalFactory","ModalEvents","Fragment","Ajax","Dialog","Str","init","rewriteDataField","data","each","code","find","val","name","image","replace","push","dataField","join","on","e","preventDefault","greatestPos","pos","render","then","html","append","parent","remove","imageModal","showImageModal","show","loadFragment","M","cfg","contextid","done","js","length","replaceNodeContents","addingModal","addImageModal","rowEl","rowData","create","type","types","SAVE_CANCEL","title","body","modal","setSmall","getRoot","save","draft","attr","regex","found","match","filecomps","split","draftItemId","fileName","call","methodname","args","result","success","get_string","str","error","imgSrc","imagefile","replaceWith","hidden","row","addClass"],"mappings":"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","sourcesContent":["define([\"jquery\",\n    \"core/templates\",\n    \"core/modal_factory\",\n    \"core/modal_events\",\n    \"core/fragment\",\n    \"core/ajax\",\n    \"format_visualsections/dialog\",\n    \"core/str\"\n], function($, Templates, ModalFactory, ModalEvents, Fragment, Ajax, Dialog, Str) {\n    return {\n        init: function() {\n            var rewriteDataField = function() {\n                var data = [];\n                $('.subsectiontypes ul li').each(function() {\n                    var code = $(this).find('[name*=\"code\"]').val();\n                    var name = $(this).find('[name*=\"name\"]').val();\n                    var image = $(this).find('button.imagethumb').data('imgsrc');\n                    if (typeof(image) === 'undefined') {\n                        image = null;\n                    }\n                    code = code.replace('|', ' '); // No pipes allowed.\n                    name = name.replace('|', ' '); // No pipes allowed.\n                    data.push(code+'|'+name+'|'+image);\n                });\n                var dataField = $('.subsectiontypes .js-data-field');\n                $(dataField).val(data.join(\"\\n\"));\n            };\n\n            // Listen for add sub section.\n            $('.subsectiontypes').on('click', '.js-addsubsection', function(e) {\n                e.preventDefault();\n                var greatestPos = 0;\n\n                $('.subsectiontypes .subsectiontyperow').each(function() {\n                    var pos = $(this).data('pos');\n                    if (pos && pos > greatestPos) {\n                        greatestPos = pos;\n                    }\n                });\n\n                var data = {\n                    pos: greatestPos + 1,\n                    code: null,\n                    name: null,\n                    image: null\n                };\n                Templates.render('format_visualsections/subsectiontyperow', data)\n                    .then(function(html) {\n                        $('.subsectiontypes ul').append(html);\n                    });\n            });\n\n            // Listen for field value changes.\n            $('.subsectiontypes').on('keyup change', 'input', function(e) {\n                e.preventDefault();\n                rewriteDataField();\n            });\n\n            // Listen remove sub section.\n            $('.subsectiontypes').on('click', '.js-removesubsection', function(e) {\n                e.preventDefault();\n                $(this).parent('li').remove();\n                rewriteDataField();\n            });\n\n            var imageModal = null;\n\n            var showImageModal = function() {\n                $('#image-upload').html('<div class=\"spinner\"></div>');\n                imageModal.show();\n                return Fragment.loadFragment(\"format_visualsections\", \"filepicker\", M.cfg.contextid, [])\n                    .done(function(html, js) {\n                        if (!$(\"#image-upload\").length) {\n                            return;\n                        }\n                        Templates.replaceNodeContents(\n                            $(\"#image-upload\"),\n                            html,\n                            js\n                        );\n                    });\n            };\n\n            var addingModal = false;\n\n            var addImageModal = function(rowEl, rowData) {\n                if (imageModal) {\n                    imageModal.rowEl = rowEl;\n                    imageModal.rowData = rowData;\n                    showImageModal();\n                    return;\n                }\n                if (addingModal) {\n                    return;\n                }\n                addingModal = true;\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    title: \"Add image\",\n                    body: `<div id=\"image-upload\"></div>`\n                })\n                .then(function(modal) {\n                    imageModal = modal;\n                    imageModal.setSmall();\n                    imageModal.rowEl = rowEl;\n                    imageModal.rowData = rowData;\n                    showImageModal();\n\n                    // Handle save event.\n                    imageModal.getRoot().on(ModalEvents.save, function() {\n                        const draft = $(\".filepicker-filename a\").attr(\"href\");\n                        const regex = /(?:draftfile.php\\/)(.*)$/;\n                        const found = draft.match(regex);\n                        const filecomps = found[1].split('/');\n                        const draftItemId = filecomps[3];\n                        const fileName = filecomps[4];\n\n                        return Ajax.call([\n                            {\n                                methodname: \"format_visualsections_subtopic_addimage\",\n                                args:{\n                                    \"request\": {\"draftitemid\": draftItemId, \"filename\": fileName}\n                                }\n                            }\n                        ])[0]\n                            .then(function(result) {\n                                if (!result.success) {\n                                    Str.get_string(\"failedtouploadimage\", \"format_visualsections\")\n                                        .then(function(str) {\n                                            Dialog.error(\n                                                str,\n                                                ''\n                                            );\n                                        });\n                                }\n                                var imgSrc = result.imagefile;\n                                modal.rowData.image = imgSrc;\n                                Templates.render('format_visualsections/subsectiontyperow', modal.rowData)\n                                    .then(function(html) {\n                                        $(modal.rowEl).replaceWith(html);\n                                        rewriteDataField();\n                                    });\n                            });\n                    });\n\n                    modal.getRoot().on(ModalEvents.hidden, function() {\n                        $(\"#image-upload\").html(\"\");\n                    });\n                });\n            };\n\n            // Listen add image.\n            $('.subsectiontypes').on('click', '.js-setimage', function(e) {\n                e.preventDefault();\n                const row = $(this).parent('.subsectiontyperow');\n                const code = $(row).find('[name*=\"code\"]').val();\n                const name = $(row).find('[name*=\"name\"]').val();\n                const image = $(this).data('imgsrc');\n                const rowData = {\n                    code: code,\n                    name: name,\n                    image: image\n                };\n\n                addImageModal(row, rowData);\n            });\n\n            $('.subsectiontypes').addClass('jsloaded');\n        }\n    };\n});"],"file":"adminsetting_subsectiontypes.min.js"}