define ("format_visualsections/subsections",["jquery","core/yui","core/modal_factory","core/modal_events","core/ajax","core/fragment","core/templates","core/str","core/event","format_visualsections/utils","format_visualsections/sectioncircle","format_visualsections/carousel","format_visualsections/dialog"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n={SUBSECTION_FORM_CONT:"subsectionformcontainer",CAROUSEL_CONT:"section-carousel-content",FOOTER:"format-footer"};return{init:function init(o,p,q){var r=null,s=null;k.applySegments(o);b.use("dd-drop",function(b){a(".subsection").each(function(){new b.DD.Drop({node:"#"+a(this).attr("id")})})});var t=function(b){if("string"!=typeof b&&!(b instanceof String)){b=new URLSearchParams(b).toString()}var c=M.cfg.contextid,d=b?{formdata:b}:null;return f.loadFragment("format_visualsections","subsection_form",c,d).done(function(b,c){if(!a("#"+n.SUBSECTION_FORM_CONT).length){return}g.replaceNodeContents(a("#"+n.SUBSECTION_FORM_CONT),b,c);var d="#"+n.SUBSECTION_FORM_CONT+" form";a(d).on("submit",function(a){a.preventDefault();return!1})})},u=function(){var b=a.Deferred(),e="<div id=\"".concat(n.SUBSECTION_FORM_CONT,"\"></div>");if(!r){c.create({title:"",type:"SAVE_CANCEL",body:e,large:!0}).then(function(c){r=c;c.getRoot().on(d.save,function(b){b.preventDefault();var d=a("#"+n.SUBSECTION_FORM_CONT+" form");a(d).trigger("save-form-state");var e=a(d).serialize();t(e).then(function(){var a=c.getModal();if(a.find(".alert-success").length){var b=a.find("form input[name='id']").val();window.onbeforeunload=null;window.location=M.cfg.wwwroot+"/course/view.php?id="+o+"#subsection"+b;c.hide();window.location.reload()}})});c.getRoot().on(d.cancel,function(){c.hide()});c.getRoot().on(d.hide,function(){c.setBody("")});b.resolve(c)})}else{b.resolve(r)}return b},v=function(b){s=a(b).data("sectionid");var c=a(b).closest(".section"),d=c.find(".subsections .subsection").length;if(5<=d){h.get_string("toomanysubsections","format_visualsections").then(function(a){m.error(a,"")});return}u().then(function(){return h.get_strings([{key:"addsubsection",component:"format_visualsections"}])}).then(function(b){r.setTitle(b[0]);r.show();a("#"+n.SUBSECTION_FORM_CONT).html("<div class=\"spinner\"></div>");t({parentid:s})})};a("body").on("click",".js-add-subsection",function(){v(this)});var w=function(b){var c=a(b).closest(".subsection").data("subsection-id");u().then(function(){return h.get_strings([{key:"editsubsection",component:"format_visualsections"}])}).then(function(b){r.setTitle(b[0]);r.show();a("#"+n.SUBSECTION_FORM_CONT).html("<div class=\"spinner\"></div>");t({id:c,course:o})})};a("body").on("click",".js-edit-subsection",function(){w(this)});var x=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0,c=document.querySelector(a),d=c.getBoundingClientRect().top+window.pageYOffset+b;window.scrollTo({top:d,behavior:"smooth"})},y=function(b){if(b.indexOf("subsection")){b=b.replace("subsection","subsect")}a("#section-carousel").addClass("carousel-ready");var c=a(b.replace("subsect","subsection")).closest(".section");z("#"+a(c).attr("id"));var d=b.replace("subsect","subsection")+" > .section";j.whenTrue(function(){return"function"==typeof window.$(d).collapse}).then(function(){window.$(d).collapse("show");setTimeout(function(){var b=a(".fixed-top.navbar"),c=b.length?b.outerHeight():40;x(d,0-(100+c))},200)})},z=function(b){var d=a(b);a("ul.visualsections > li.section").removeClass("active");a(b).addClass("active");var e,h=a(d).parents("div.subsection");if(h.length){var i=a(h).parents("li.section");a(i).addClass("active");e=a(i).attr("id")}else{e=b}var j=/(?:section)-(\d+)$/,k=e.match(j),l=k[1],m=a("#section-circle-"+l).closest(".carousel-item");a("#section-carousel .carousel-item").removeClass("active");m.addClass("active");var p=0,q=0;a("#section-carousel .carousel-item").each(function(){p++;if(a(this).hasClass("active")){q=p}});a("#section-carousel .carousel-indicators li").removeClass("active");a("#section-carousel .carousel-indicators li:nth-child("+q+")").addClass("active");a("#section-carousel").addClass("carousel-ready");var r=M.cfg.contextid;f.loadFragment("format_visualsections","footer",r,{courseid:o,section:l}).done(function(b,c){if(!a("#"+n.FOOTER).length){return}g.replaceNode(a("#"+n.FOOTER),b,c);a("#".concat(n.FOOTER," button[data-toggle=\"tooltip\"]")).tooltip()})},A=function(b){var c=location.hash;if(0===c.indexOf("#subsect")){y(c)}else if(0===c.indexOf("#section")){z(c)}else if(b&&!p){location.hash="#"+q}else{a("#section-carousel").addClass("carousel-ready")}};a("document").ready(function(a){A(!0,a)});a(window).on("hashchange",function(a){A(!1,a)});var B=!1;a("body").on("click",".togglecompletion",function(){B=!0});i.getLegacyEvents().done(function(b){a(document).on(b.FILTER_CONTENT_UPDATED,function(){if(!B){return}B=!1;a("#section-carousel").removeClass("carousel-ready");var b=M.cfg.contextid;f.loadFragment("format_visualsections","carousel",b,{courseid:o}).done(function(b,c){if(!a("#"+n.CAROUSEL_CONT).length){return}g.replaceNodeContents(a("#"+n.CAROUSEL_CONT),b,c);k.applySegments(o);l.init();A()})})});a("body").on("click","#".concat(n.FOOTER," .js-nav"),function(b){b.preventDefault();if(a(this).attr("disabled")){return}var c=a(this).data("section");location.hash="#section-"+c});a("body").on("click",".js-move-subsection",function(){var b=a(this).data("direction"),c=a(this).closest("div.subsection"),d=a(c).data("subsection-id"),f=null;if("up"===b){f=a(c).prev("div.subsection")}else{f=a(c).next("div.subsection")}var g=a(this).closest("li.section"),i=a(g).data("section-id"),j=null;if(f.length){if("up"===b){a(c).after(f)}else{a(c).before(f)}j=a(f).data("subsection-id")}else{var k=null;if("up"===b){k=a(g).prev("li.section")}else{k=a(g).next("li.section")}if(k.length){j=d}else{return}g=k;i=g.data("section-id");g.find(".subsections").append(c)}e.call([{methodname:"format_visualsections_move_subtopic",args:{request:{parentsectionid:i,srcsectionid:d,targetsectionid:j}}}])[0].then(function(a){if(!a.success){h.get_string("failedtomovesubsection","format_visualsections").then(function(a){m.error(a,"")})}})})}}});
//# sourceMappingURL=subsections.min.js.map
