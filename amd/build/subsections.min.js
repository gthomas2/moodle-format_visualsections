define ("format_visualsections/subsections",["jquery","core/yui","core/modal_factory","core/modal_events","core/ajax","core/fragment","core/templates","core/str","core/event","format_visualsections/utils","format_visualsections/sectioncircle","format_visualsections/carousel"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m={SUBSECTION_FORM_CONT:"subsectionformcontainer",CAROUSEL_CONT:"section-carousel-content",FOOTER:"format-footer"};return{init:function init(n,o,p){var q=null,r=null;k.applySegments(n);b.use("dd-drop",function(b){a(".subsection").each(function(){new b.DD.Drop({node:"#"+a(this).attr("id")})})});var s=function(b){if("string"!=typeof b&&!(b instanceof String)){b=new URLSearchParams(b).toString()}var c=M.cfg.contextid,d=b?{formdata:b}:null;return f.loadFragment("format_visualsections","subsection_form",c,d).done(function(b,c){if(!a("#"+m.SUBSECTION_FORM_CONT).length){return}g.replaceNodeContents(a("#"+m.SUBSECTION_FORM_CONT),b,c)})},t=function(){var b=a.Deferred(),e="<div id=\"".concat(m.SUBSECTION_FORM_CONT,"\"></div>");if(!q){c.create({title:"",type:"SAVE_CANCEL",body:e,large:!0}).then(function(c){q=c;c.getRoot().on(d.save,function(b){b.preventDefault();var d=a("#"+m.SUBSECTION_FORM_CONT+" form");a(d).trigger("save-form-state");var e=a(d).serialize();s(e).then(function(){var a=c.getModal();if(a.find(".alert-success").length){var b=a.find("form input[name='id']").val();window.onbeforeunload=null;window.location=M.cfg.wwwroot+"/course/view.php?id="+n+"#subsection"+b;c.hide();window.location.reload()}})});c.getRoot().on(d.cancel,function(){c.hide()});c.getRoot().on(d.hide,function(){c.setBody("")});b.resolve(c)})}else{b.resolve(q)}return b},u=function(b){r=a(b).data("sectionid");var c=a(b).closest(".section"),d=c.find(".subsections .subsection").length;if(5<=d){alert("too many sections");return}t().then(function(){return h.get_strings([{key:"addsubsection",component:"format_visualsections"}])}).then(function(b){q.setTitle(b[0]);q.show();a("#"+m.SUBSECTION_FORM_CONT).html("<div class=\"spinner\"></div>");s({parentid:r})})};a("body").on("click",".js-add-subsection",function(){u(this)});var v=function(b){var c=a(b).closest(".subsection").data("subsection-id");t().then(function(){return h.get_strings([{key:"editsubsection",component:"format_visualsections"}])}).then(function(b){q.setTitle(b[0]);q.show();a("#"+m.SUBSECTION_FORM_CONT).html("<div class=\"spinner\"></div>");s({id:c,course:n})})};a("body").on("click",".js-edit-subsection",function(){v(this)});var w=function(b){a("#section-carousel").addClass("carousel-ready");var c=b+" > .section";j.whenTrue(function(){return"function"==typeof window.$(c).collapse}).then(function(){window.$(c).collapse("show");setTimeout(function(){var c=a(".fixed-top.navbar"),d=c.length?c.outerHeight():40;a("html, body").animate({scrollTop:a(b).offset().top-d},200)},200)})},x=function(b){var d=a(b);a("ul.visualsections > li.section").removeClass("active");a(b).addClass("active");var e,h=a(d).parents("div.subsection");if(h.length){var i=a(h).parents("li.section");a(i).addClass("active");e=a(i).attr("id")}else{e=b}var j=/(?:section)-(\d+)$/,k=e.match(j),l=k[1],o=a("#section-circle-"+l).closest(".carousel-item");a("#section-carousel .carousel-item").removeClass("active");o.addClass("active");var p=0,q=0;a("#section-carousel .carousel-item").each(function(){p++;if(a(this).hasClass("active")){q=p}});a("#section-carousel .carousel-indicators li").removeClass("active");a("#section-carousel .carousel-indicators li:nth-child("+q+")").addClass("active");a("#section-carousel").addClass("carousel-ready");var r=M.cfg.contextid;f.loadFragment("format_visualsections","footer",r,{courseid:n,section:l}).done(function(b,c){if(!a("#"+m.FOOTER).length){return}g.replaceNode(a("#"+m.FOOTER),b,c);a("#".concat(m.FOOTER," button[data-toggle=\"tooltip\"]")).tooltip()})},y=function(b){var c=location.hash;if(0===c.indexOf("#subsection")){w(c)}else if(0===c.indexOf("#section")){x(c)}else if(b&&!o){location.hash="#"+p}else{a("#section-carousel").addClass("carousel-ready")}};a("document").ready(function(a){y(!0,a)});a(window).on("hashchange",function(a){y(!1,a)});var z=!1;a("body").on("click",".togglecompletion",function(){z=!0});i.getLegacyEvents().done(function(b){a(document).on(b.FILTER_CONTENT_UPDATED,function(){if(!z){return}z=!1;a("#section-carousel").removeClass("carousel-ready");var b=M.cfg.contextid;f.loadFragment("format_visualsections","carousel",b,{courseid:n}).done(function(b,c){if(!a("#"+m.CAROUSEL_CONT).length){return}g.replaceNodeContents(a("#"+m.CAROUSEL_CONT),b,c);k.applySegments(n);l.init();y()})})});a("body").on("click","#".concat(m.FOOTER," .js-nav"),function(b){b.preventDefault();if(a(this).attr("disabled")){return}var c=a(this).data("section");location.hash="#section-"+c});a("body").on("click",".js-move-subsection",function(){var b=a(this).data("direction"),c=a(this).closest("div.subsection"),d=a(c).data("subsection-id"),f=null;if("up"===b){f=a(c).prev("div.subsection")}else{f=a(c).next("div.subsection")}var g=a(this).closest("li.section"),h=a(g).data("section-id"),i=null;if(f.length){if("up"===b){a(c).after(f)}else{a(c).before(f)}i=a(f).data("subsection-id")}else{var j=null;if("up"===b){j=a(g).prev("li.section")}else{j=a(g).next("li.section")}if(j.length){i=d}else{return}g=j;h=g.data("section-id");g.find(".subsections").append(c)}e.call([{methodname:"format_visualsections_move_subtopic",args:{request:{parentsectionid:h,srcsectionid:d,targetsectionid:i}}}])[0].then(function(a){if(!a.success){alert("Error: failed to move sub section")}})})}}});
//# sourceMappingURL=subsections.min.js.map
