{"version":3,"sources":["../src/subsections.js"],"names":["define","$","ModalFactory","ModalEvents","Ajax","Fragment","Templates","consts","SUBSECTION_FORM_CONT","init","modalAddSubsection","sectionId","loadSubsectionForm","data","String","URLSearchParams","toString","rx","result","exec","attr","contextid","parseInt","params","formdata","loadFragment","done","html","js","length","replaceNodeContents","addSubsectionModal","el","bodyHTML","showModal","show","parentid","create","title","type","body","large","then","modal","getRoot","on","save","e","preventDefault","form","trigger","serialize","getModal","find","hide","cancel","setBody"],"mappings":"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","sourcesContent":["define(['jquery', 'core/modal_factory', 'core/modal_events', 'core/ajax', 'core/fragment', \"core/templates\"],\n    function($, ModalFactory, ModalEvents, Ajax, Fragment, Templates) {\n    var consts = {\n        SUBSECTION_FORM_CONT: 'subsectionformcontainer'\n    };\n    return {\n        init: function() {\n            var modalAddSubsection = null;\n            var sectionId = null;\n\n            var loadSubsectionForm = function(data) {\n                if (typeof data !== 'string' && !(data instanceof String)) {\n                    data = new URLSearchParams(data).toString();\n                }\n                const rx = new RegExp('(?:context-)(\\\\S)');\n                const result = rx.exec($('body').attr('class'));\n                const contextid = parseInt(result[1]);\n                const params = data ? {formdata: data} : null;\n\n                return Fragment.loadFragment('format_visualsections', 'subsection_form', contextid, params)\n                    .done(function(html, js) {\n                        if (!$(\"#\" + consts.SUBSECTION_FORM_CONT).length) {\n                            return;\n                        }\n                        Templates.replaceNodeContents(\n                            $(\"#\" + consts.SUBSECTION_FORM_CONT),\n                            html,\n                            js\n                        );\n                    });\n            };\n\n            var addSubsectionModal = function(el) {\n                sectionId = $(el).data('sectionid');\n\n                var bodyHTML = '<div id=\"'+consts.SUBSECTION_FORM_CONT+'\"></div>';\n\n                var showModal = function() {\n                    modalAddSubsection.show();\n                    loadSubsectionForm({parentid: sectionId});\n                };\n\n                if (!modalAddSubsection) {\n                    ModalFactory.create({\n                        title: 'Add subsection',\n                        type: 'SAVE_CANCEL',\n                        body: bodyHTML,\n                        large: true,\n                    }).then(function(modal) {\n                        modalAddSubsection = modal;\n                        modal.getRoot().on(ModalEvents.save, function(e) {\n                            e.preventDefault(); // We don't want to close the modal yet.\n                            var form = $('#' + consts.SUBSECTION_FORM_CONT + ' form');\n                            $(form).trigger('save-form-state');\n\n                            var data = $(form).serialize();\n                            loadSubsectionForm(data)\n                                .then(function() {\n                                    if (modal.getModal().find('.alert-success').length) {\n                                        modal.hide();\n                                    }\n                                });\n\n                        });\n                        modal.getRoot().on(ModalEvents.cancel, function() {\n                            modal.hide();\n                        });\n                        modal.getRoot().on(ModalEvents.hide, function() {\n                            modal.setBody('');\n                        });\n                        showModal();\n                    });\n                } else {\n                    showModal();\n                }\n            };\n\n            $('body').on('click', '.js-add-subsection', function() {addSubsectionModal(this);});\n        }\n    };\n});"],"file":"subsections.min.js"}